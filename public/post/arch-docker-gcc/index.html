<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  
<title>RustプロジェクトのビルドテストをGithub Actionsで行う（Arch Linuxのタグに要注意） | tudurikata</title>


  <link rel="shortcut icon" type="image/png" href="&#x2F;images&#x2F;penguin.png">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  
  <link id="stylesheet" rel="stylesheet" type="text/css" href="/dark.css">
  

<script type="text/javascript" src="/js/theme.js"></script>

</head>

<div class="header">
  <div class="site_title">
    <p><a href="/"><img src="https:&#x2F;&#x2F;tudurikata.com&#x2F;images&#x2F;penguin.png"
      alt="tudurikata" width="70" height=auto></a></p>
    <p><a href="/">&nbsp;tudurikata</a></p>
  </div>
  <div class="menu">
    <a href="/post">>archives</a>
    &nbsp;<a href="/about">>about</a>

    

  </div>
</div>

<body onload = "getTheme()">
  <section class="section">
    <div class="container">
      
<p>
  <div class="title_postpage">RustプロジェクトのビルドテストをGithub Actionsで行う（Arch Linuxのタグに要注意）</div>
</p>
<p>
  <div class="date_postpage">2021-11-25</div>
  <div class="taxonomies_postpage">
  
      
      <a href="https://tudurikata.com/categories/code/">/code</a>
      
  
  
      
      &emsp;<a href="https://tudurikata.com/tags/github-actions/">#Github Actions</a>
      
      &emsp;<a href="https://tudurikata.com/tags/arch-linux/">#Arch Linux</a>
      
      &emsp;<a href="https://tudurikata.com/tags/docker/">#docker</a>
      
      &emsp;<a href="https://tudurikata.com/tags/rust/">#Rust</a>
      
  
  </div>
</p>

<p>
  <p>タイトルの通りなのだが、若干ハマったので記録しておきます。</p>
<p>Rustのプロジェクトにおいて、自分のローカル環境以外でもうまくインストールできるかのテストを行うためにGitHub Actionsを使っている。</p>
<pre><code># .github&#x2F;workflows&#x2F;install_test.yml

name: &#x27;install test&#x27;

on:
  push:
    branches-ignore: &#x27;main&#x27;
    paths-ignore:
      - &#x27;*.md&#x27;

env:
  CARGO_TERM_COLOR: always

jobs:
  ubuntu-install:
    runs-on: ubuntu-latest
    steps:
    - uses: actions&#x2F;checkout@v2
    - name: Install
      run: |
        cargo install --path .
  macos-install:
    runs-on: macos-latest
    steps:
    - uses: actions&#x2F;checkout@v2
    - name: Install
      run: |
        cargo install --path .
  archlinux-install:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
    - uses: actions&#x2F;checkout@v2
    - name: Install
      run: |
        pacman -Syu --noconfirm
        pacman -S gcc --noconfirm
        pacman -S rustup --noconfirm
        rustup install stable
        rustup default stable
        cargo install --path .
</code></pre>
<p>jobsは３つ。Ubuntu上・macOS上・Arch Linux上それぞれでのインストールをテストしている。（<code>cargo install --path .</code>が通ればcrates.ioからのインストールも問題ないという認識）</p>
<p>ご覧の通り、UbuntuとmacOSでは特に追加でライブラリをインストールする必要なくパスしているが、archlinux:latestを使った最後のテストでは、<code>gcc</code>と<code>rustup</code>を先にインストールしている。
<code>rustup</code>がarchlinux:latestに含まれていないのは当たり前のことなのでこれは良い。問題なのは<code>gcc</code>。</p>
<p><code>gcc</code>を事前インストールしない場合、テスト中に</p>
<pre><code>error: linker `cc` not found
  |
  = note: No such file or directory (os error 2)
</code></pre>
<p>とビルドエラーが出てしまう。 </p>
<p>そもそものarchlinux:latestイメージの中に入ってみると、</p>
<pre><code># docker run -it archlinux:latest
[root@0fd34e31306a &#x2F;]# pacman -Qi gcc
warning: database file for &#x27;core&#x27; does not exist (use &#x27;-Sy&#x27; to download)
warning: database file for &#x27;extra&#x27; does not exist (use &#x27;-Sy&#x27; to download)
warning: database file for &#x27;community&#x27; does not exist (use &#x27;-Sy&#x27; to download)
error: package &#x27;gcc&#x27; was not found
</code></pre>
<p>うーん、やっぱり入ってない。<code>gcc</code>が含まれてないなんて、そんなことある？　と思いながら、テストはパスするのでそのままにしていた。</p>
<p>でもやっぱり引っかかる。そこで、よく<a href="https://hub.docker.com/_/archlinux">公式の説明</a>を読んで見ると…</p>
<blockquote>
<p>Besides <code>base</code> we also provide images for the <code>base-devel</code> package group. </p>
</blockquote>
<p>tagにちゃんと<code>base-devel</code>がある…！　そして</p>
<blockquote>
<p>The <code>latest</code> tag will always match the latest <code>base</code> tag.</p>
</blockquote>
<p>はい、ありがちな<code>base-devel</code>抜け。<br />
何も考えずlatestを使ってはいけないという教訓を得ました。</p>
<p>というわけで冒頭のymlを次のように変更。</p>
<pre><code>  archlinux-install:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    steps:
    - uses: actions&#x2F;checkout@v2
    - name: Install
      run: |
        pacman -Syu --noconfirm
        pacman -S rustup --noconfirm
        rustup install stable
        rustup default stable
        cargo install --path .
</code></pre>
<p>データベースの更新はいずれにせよ必要として、<code>gcc</code>の明示的インストールを削除。テストももちろんパス。あースッキリした。</p>

</p>




    </div>
  </section>
</body>

<div class="footer">
  <a href="/">tudurikata</a>&emsp;&copy; Kyohei Uto<br>
  powered by <a href="https://www.getzola.org/">Zola</a>, theme <a href="https://github.com/kyoheiu/emily_zola_theme">emily</a>.
</div>

</html>